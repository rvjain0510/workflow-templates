name: Create Release Branch

on:
  issues:
    types: [opened]

jobs:
  create-release-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v2

      - name: Extract issue information
        id: extract
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          echo "Issue Body:"
          echo "$ISSUE_BODY"
          
          EXTRACTED_KEYWORDS=$(echo "$ISSUE_BODY" | awk '/### What kinds of M&Ms do you like?/{flag=1;next}/###/{flag=0}flag' | grep -oP '(?<=\[X\] ).*')
          
          echo "Extracted Keywords: $EXTRACTED_KEYWORDS"
          
          # Set environment variable
          echo "KEYWORDS=$EXTRACTED_KEYWORDS" >> $GITHUB_ENV
          


      - name: Check if keyword is empty
        run: |
          if [ -z "${{ env.KEYWORD }}" ]; then
            echo "No keyword selected. Exiting workflow."
            exit 1
          fi

      - name: Check for open PRs with specific keyword
        id: check_open_prs
        run: |
          # Convert keywords to array (if there are multiple keywords)
          IFS=',' read -r -a KEYWORDS_ARRAY <<< "$KEYWORD"
          
          # Fetch open PRs and filter by each keyword
          OPEN_PR_COUNT=0
          for keyword in "${KEYWORDS_ARRAY[@]}"; do
            PR_COUNT=$(curl -s -H "Authorization: token ${{ secrets.TESTY }}" \
                       -H "Accept: application/vnd.github.v3+json" \
                       "https://api.github.com/repos/${{ github.repository }}/pulls?state=open" \
                       | jq ".[] | select(.title | test(\"$keyword\")) | .number" \
                       | wc -l)
            OPEN_PR_COUNT=$((OPEN_PR_COUNT + PR_COUNT))
          done
          
          echo "Open PRs with keyword(s) '$KEYWORD': $OPEN_PR_COUNT"
          echo "::set-output name=open_pr_count::$OPEN_PR_COUNT"

      - name: Check if there are open PRs
        if: steps.check_open_prs.outputs.open_pr_count != '0'
        run: |
          echo "There are open PRs with the keyword(s). Skipping release branch creation."
          exit 0  # Exit successfully to skip further steps
